{% load static %}
{% load bsc_extras %}
<!DOCTYPE html>
<html>

<head>
    <title>Dashboard</title>
    <link href="{% static 'css/tailwind.build.css' %}" rel="stylesheet">
    <style>
    .vertical-text {
        writing-mode: vertical-rl;
        transform: rotate(180deg);
        text-align: center;
        white-space: nowrap;
        min-width: 60px;
        padding: 0 12px;
        height: 140px;
        vertical-align: middle;
        display: table-cell;
    }
    </style>
</head>

<body class="bg-gray-50 min-h-screen">
    <nav class="bg-white shadow mb-8">
        <div class="mx-[26px] flex justify-between items-center h-full">
            <a href="/" class="text-2xl font-bold text-blue-700">BSC Generator</a>
            <div class="flex gap-2 items-center space-x-6 p-6">
                <p class="text-sm font-semibold bg-green-300 rounded-full px-3 py-1">{% if is_admin %}Admin{% elif is_employee %}Employee{% endif %}</p>
                <div class="flex items-center gap-2">
                    <img src="{% static 'assets/abstract.jpg' %}" alt="Profile" class="w-8 h-8 rounded-full border-2 border-blue-400 object-cover" />
                    <a href="#" class="text-gray-700 hover:text-blue-600 font-semibold">{{ user.username }}</a>
                </div>
                <a href="{% url 'logout' %}" class="text-red-600 hover:underline font-semibold">Logout</a>
            </div>
        </div>
    </nav>
    <div class="mx-[150px]">
            <p class="mb-4 font-bold text-xl text-gray-700"><span class="text-blue-600 hover:underline cursor-default">{{ organization.name }}'s</span> Balanced Scorecard</p>
            {% if is_admin %}
            <div class="bg-white rounded-lg shadow p-6 mb-4">
                <h3 class="text-lg font-bold text-blue-600 mb-2">Manager/Admin Controls</h3>
                <ul class="list-disc list-inside mb-4 text-gray-700">
                    <li>Full access to dashboard features.</li>
                    <li>View reports and analytics.</li>
                </ul>
                <h4 class="text-lg font-semibold mb-2">Upload BSC CSV/Excel Data</h4>
                <p class="text-sm text-gray-500 mb-2"><em>Required columns: perspective, objective, measure, target,
                        actual. Optional: owner, date.</em></p>
                {% if messages %}
                <ul class="mb-2">
                    {% for message in messages %}
                    <li
                        class="text-sm {% if message.tags == 'success' %}text-green-600{% else %}text-red-600{% endif %}">
                        {{ message }}</li>
                    {% endfor %}
                </ul>
                {% endif %}
                <form method="post" enctype="multipart/form-data" class="flex flex-col sm:flex-row items-center gap-2">
                    {% csrf_token %}
                    <input type="file" name="data_file" accept=".csv,.xlsx,.xls" required
                        class="block w-full text-sm text-gray-700 border border-gray-300 rounded px-2 py-1 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <button type="submit"
                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 font-semibold">Upload</button>
                </form>
            </div>
            {% elif is_employee %}
            <div class="bg-white rounded-lg shadow p-6 mb-4">
                <h3 class="text-xl font-bold text-blue-600 mb-2">Employee View</h3>
                <ul class="list-disc list-inside text-gray-700">
                    <li>View-only access to dashboard data.</li>
                </ul>
            </div>
            {% else %}
            <div class="bg-white rounded-lg shadow p-6 mb-6">
                <p>Your role is not assigned. Please contact your administrator.</p>
            </div>
            {% endif %}
            {% if is_admin or is_employee %}
                {% if bsc_batches and bsc_batches|length > 0 %}
            <div class="flex items-center mb-4">
                <div class="flex items-center gap-2">
                    <button id="toggle-bsc-detailed" type="button"
                        class="inline-block bg-blue-600 text-white px-4 py-2 rounded font-semibold shadow hover:bg-blue-700 transition">
                        View Detailed BSC Entries
                    </button>
                </div>
                {% if is_admin %}
                <button type="button"
                    id="show-delete-modal-btn"
                    class="bg-red-700 hover:bg-red-900 text-white font-semibold px-4 py-2 rounded ml-1">
                    Delete All BSC Data
                </button>
                <!-- Modal -->
                <div id="delete-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-40 hidden">
                    <div class="bg-white rounded-lg shadow-lg p-6 w-full max-w-sm">
                        <h2 class="text-lg font-bold mb-4 text-red-700">Confirm Delete All BSC Data</h2>
                        <form id="delete-all-bsc-form" method="post" action="{% url 'delete_bsc_data' %}">
                            {% csrf_token %}
                            <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-2">Enter your password:</label>
                            <input type="password" name="admin_password" id="admin-password" required
                                class="w-full px-3 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:ring-2 focus:ring-red-400 mb-4">
                            <div class="flex justify-end gap-2">
                                <button type="button" id="cancel-delete-modal" class="px-4 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold">Cancel</button>
                                <button type="submit" class="px-4 py-2 rounded bg-red-700 hover:bg-red-900 text-white font-semibold">Confirm Delete</button>
                            </div>
                        </form>
                    </div>
                </div>
                <script>
                    // Show modal
                    document.getElementById('show-delete-modal-btn').addEventListener('click', function() {
                        document.getElementById('delete-modal').classList.remove('hidden');
                    });
                    // Hide modal
                    document.getElementById('cancel-delete-modal').addEventListener('click', function() {
                        document.getElementById('delete-modal').classList.add('hidden');
                        document.getElementById('admin-password').value = '';
                    });
                    // Optional: Prevent form submit if password is empty (HTML5 required already does this)
                    document.getElementById('delete-all-bsc-form').addEventListener('submit', function(e) {
                        if (!document.getElementById('admin-password').value) {
                            alert('Please enter your password to delete all BSC data.');
                            e.preventDefault();
                        } else if (!confirm('Are you sure you want to delete all BSC data? This action cannot be undone.')) {
                            e.preventDefault();
                        }
                    });
                </script>
                {% endif %}
            </div>
            {% endif %}
            </div>

        <div id="bsc-detailed-section" class="hidden mb-8">
            <div class="max-w-5xl mx-auto py-8 px-4">
                <h2 class="text-3xl font-bold text-blue-700 mb-6">Detailed BSC View</h2>
                <div class="mb-6">
                    <div class="flex space-x-2" id="bsc-tabs">
                        <button
                            class="tab-btn px-4 py-2 rounded-t bg-blue-100 text-blue-700 font-semibold focus:outline-none"
                            data-perspective="Financial">Financial</button>
                        <button
                            class="tab-btn px-4 py-2 rounded-t bg-blue-100 text-blue-700 font-semibold focus:outline-none"
                            data-perspective="Customer">Customer</button>
                        <button
                            class="tab-btn px-4 py-2 rounded-t bg-blue-100 text-blue-700 font-semibold focus:outline-none"
                            data-perspective="Internal">Internal</button>
                        <button
                            class="tab-btn px-4 py-2 rounded-t bg-blue-100 text-blue-700 font-semibold focus:outline-none"
                            data-perspective="Learning & Growth">Learning & Growth</button>
                    </div>
                </div>
                <div id="bsc-tab-content">
                    <!-- Tab content will be rendered here -->
                </div>
            </div>
            <script>
                var bscData = {
                    'Financial': [],
                    'Customer': [],
                    'Internal': [],
                    'Learning & Growth': []
                };
                {% if bsc_batches and bsc_batches|length > 0 %}
                  {% with last_batch=bsc_batches|last %}
                    {% for entry in last_batch.entries %}
                      bscData["{{ entry.perspective|escapejs }}"].push({
                          objective: "{{ entry.objective|escapejs }}",
                          measure: "{{ entry.measure|escapejs }}",
                          target: parseFloat("{{ entry.target|default:'0'|escapejs }}"),
                          actual: parseFloat("{{ entry.actual|default:'0'|escapejs }}"),
                          owner: "{{ entry.owner|escapejs }}",
                          date: "{{ entry.date }}",
                          pk: "{{ entry.pk }}",
                          model_type: "{{ entry.model_type }}"
                      });
                    {% endfor %}
                  {% endwith %}
                {% endif %}
                function renderTab(perspective) {
                    var data = bscData[perspective] || [];
                    var html = '';
                    if (data.length === 0) {
                        html += '<div class="bg-white rounded shadow p-6 mb-6 text-gray-500">No entries for this perspective.</div>';
                    } else {
                        html += '<div class="bg-white rounded shadow p-6 mb-6">' +
                            '<canvas id="bscChart" height="300"></canvas>' +
                            '</div>';
                        html += '<div class="bg-white rounded shadow p-6">' +
                            '<table class="min-w-full border border-gray-200 rounded-lg overflow-hidden">' +
                            '<thead class="bg-blue-100">' +
                            '<tr>' +
                            '<th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Objective</th>' +
                            '<th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Measure</th>' +
                            '<th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Target</th>' +
                            '<th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Actual</th>' +
                            '<th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Owner</th>' +
                            '<th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Date</th>' +
                            '<th class="px-3 py-2 text-center text-xs font-semibold text-blue-700 border border-gray-300">Status</th>' +
                            '</tr>' +
                            '</thead>' +
                            '<tbody class="bg-white divide-y divide-gray-100">' +
                            data.map(function (entry) {
                                return '<tr>' +
                                    '<td class="px-3 py-2 border border-gray-300">' + entry.objective + '</td>' +
                                    '<td class="px-3 py-2 border border-gray-300">' + entry.measure + '</td>' +
                                    '<td class="px-3 py-2 border border-gray-300">' + entry.target + '</td>' +
                                    '<td class="px-3 py-2 border border-gray-300">' + entry.actual + '</td>' +
                                    '<td class="px-3 py-2 border border-gray-300">' + entry.owner + '</td>' +
                                    '<td class="px-3 py-2 border border-gray-300">' +
                                    (function () {
                                        if (entry.date) {
                                            return entry.date.split('T')[0];
                                        } else {
                                            return '';
                                        }
                                    })() +
                                    '</td>' +
                                    '<td class="px-3 py-2 text-center border border-gray-300">' +
                                    (function () {
                                        if (entry.actual >= entry.target) {
                                            return '<span class="inline-block w-4 h-4 rounded-full bg-green-500 border-2 border-green-700" title="Good"></span>';
                                        } else if (entry.actual >= 0.8 * entry.target) {
                                            return '<span class="inline-block w-4 h-4 rounded-full bg-yellow-400 border-2 border-yellow-600" title="Moderate"></span>';
                                        } else {
                                            return '<span class="inline-block w-4 h-4 rounded-full bg-red-500 border-2 border-red-700" title="Bad"></span>';
                                        }
                                    })() +
                                    '</td>' +
                                    '</tr>';
                            }).join('') +
                            '</tbody>' +
                            '</table>' +
                            '</div>';
                    }
                    document.getElementById('bsc-tab-content').innerHTML = html;
                    if (data.length > 0) {
                        var ctx = document.getElementById('bscChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: data.map(function (e) { return e.objective; }),
                                datasets: [
                                    { label: 'Actual', data: data.map(function (e) { return e.actual; }), backgroundColor: 'rgba(34,197,94,0.7)' },
                                    { label: 'Target', data: data.map(function (e) { return e.target; }), backgroundColor: 'rgba(59,130,246,0.7)' }
                                ]
                            },
                            options: {
                                responsive: true,
                                plugins: { legend: { position: 'top' }, title: { display: true, text: perspective + ' KPIs: Actual vs Target' } }
                            }
                        });
                    }
                }
                document.addEventListener('DOMContentLoaded', function () {
                    var tabBtns = document.querySelectorAll('.tab-btn');
                    var activeTab = 'Financial';
                    function setActive(tab) {
                        tabBtns.forEach(function (btn) {
                            if (btn.dataset.perspective === tab) {
                                btn.classList.add('bg-white', 'border-b-2', 'border-blue-600');
                                btn.classList.remove('bg-blue-100');
                            } else {
                                btn.classList.remove('bg-white', 'border-b-2', 'border-blue-600');
                                btn.classList.add('bg-blue-100');
                            }
                        });
                    }
                    tabBtns.forEach(function (btn) {
                        btn.addEventListener('click', function () {
                            activeTab = this.dataset.perspective;
                            setActive(activeTab);
                            renderTab(activeTab);
                        });
                    });
                    setActive(activeTab);
                    renderTab(activeTab);
                });
                // Toggle logic
                document.getElementById('toggle-bsc-detailed').addEventListener('click', function () {
                    var section = document.getElementById('bsc-detailed-section');
                    if (section.classList.contains('hidden')) {
                        section.classList.remove('hidden');
                        this.textContent = 'Hide Detailed BSC Entries';
                    } else {
                        section.classList.add('hidden');
                        this.textContent = 'View Detailed BSC Entries';
                    }
                });
            </script>
        </div>
        <div class="mx-[150px] bg-white rounded-lg shadow p-6 mb-6">
            {% if bsc_batches and bsc_batches|length > 0 %}
            <div class="space-y-4">
                {% for batch in bsc_batches %}
                <div class="bg-white rounded-lg shadow p-4">
                    <div class="w-full flex justify-between items-center">
                        <button type="button" class="text-left font-bold text-blue-700 flex-1" onclick="this.parentElement.nextElementSibling.classList.toggle('hidden')">
                            Batch {{ batch.batch_id }} — Uploaded: {{ batch.upload_time|date:"Y-m-d H:i" }}
                        </button>
                        {% if is_admin %}
                        <div class="flex items-center gap-2 ml-2">
                            <form method="post" action="#" onsubmit="return false;">
                                {% csrf_token %}
                                <button type="button"
                                    class="bg-green-600 hover:bg-green-700 text-white text-sm px-3 py-2 rounded font-semibold"
                                    onclick="enableBatchEdit('{{ batch.batch_id }}')"
                                    id="edit-btn-{{ batch.batch_id }}">
                                    Update BSC Data
                                </button>
                                <button type="button" class="hidden bg-blue-600 hover:bg-blue-700 text-white text-sm px-3 py-2 rounded font-semibold" id="save-btn-{{ batch.batch_id }}" onclick="saveBatchEdit('{{ batch.batch_id }}')">Save</button>
                                <button type="button" class="hidden bg-gray-400 hover:bg-gray-600 text-white text-sm px-3 py-2 rounded font-semibold" id="cancel-btn-{{ batch.batch_id }}" onclick="cancelBatchEdit('{{ batch.batch_id }}')">Cancel</button>
                            </form>
                            <form method="post" action="{% url 'delete_batch' batch.batch_id %}">
                                {% csrf_token %}
                                <button type="submit" 
                                    onclick="return confirm('Are you sure you want to delete Batch {{ batch.batch_id }}? This action cannot be undone.');"
                                    class="bg-red-600 hover:bg-red-700 text-white text-sm px-3 py-2 rounded font-semibold">
                                    Delete Batch
                                </button>
                            </form>
                        </div>
                        {% endif %}
                    </div>
                    <div class="mt-2 hidden">
                        <form method="post" action="{% url 'update_batch' batch.batch_id %}" id="batch-form-{{ batch.batch_id }}">
                            {% csrf_token %}
                            <table class="min-w-full border border-gray-200 rounded-lg overflow-hidden" id="batch-table-{{ batch.batch_id }}">
                                <thead class="bg-blue-100">
                                    <tr>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Perspective</th>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Objective</th>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Measure</th>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Target</th>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Actual</th>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Owner</th>
                                        <th class="px-3 py-2 text-left text-xs font-semibold text-blue-700 border border-gray-300">Date</th>
                                        <th class="px-3 py-2 text-center text-xs font-semibold text-blue-700 border border-gray-300">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="bg-white divide-y divide-gray-100">
                                    {% regroup batch.entries by perspective as grouped_entries %}
                                    {% for group in grouped_entries %}
                                        {% for entry in group.list %}
                                        <tr data-model="{{ entry.model_type }}" data-pk="{{ entry.pk }}">
                                            {% if forloop.first %}
                                            <td
                                              class="px-3 py-2 border border-gray-300"
                                              style="
                                                min-width:60px;
                                                height:140px;
                                                background:
                                                  {% if group.grouper == 'Financial' %}#82aeff
                                                  {% elif group.grouper == 'Customer' %}#4d7cf3
                                                  {% elif group.grouper == 'Internal' %}#f75002
                                                  {% elif group.grouper == 'Learning & Growth' %}#fe880c
                                                  {% else %}#2563eb{% endif %};
                                              "
                                              rowspan="{{ group.list|length }}"
                                            >
                                              <p class="p-3 text-center vertical-text text-white">
                                                {% if group.grouper == "Learning & Growth" %}
                                                  Learning &<br>Growth
                                                {% else %}
                                                  {{ group.grouper }}
                                                {% endif %}
                                              </p>
                                            </td>
                                            {% endif %}
                                            <td class="px-3 py-2 border border-gray-300" data-field="objective">{{ entry.objective }}</td>
                                            <td class="px-3 py-2 border border-gray-300" data-field="measure">{{ entry.measure }}</td>
                                            <td class="px-3 py-2 border border-gray-300" data-field="target">{{ entry.target }}</td>
                                            <td class="px-3 py-2 border border-gray-300" data-field="actual">{{ entry.actual }}</td>
                                            <td class="px-3 py-2 border border-gray-300" data-field="owner">{{ entry.owner }}</td>
                                            <td class="px-3 py-2 border border-gray-300" data-field="date">
                                                {% if entry.date %}{{ entry.date|date:"Y-m-d" }}{% else %}{% endif %}
                                            </td>
                                            <td class="px-3 py-2 text-center border border-gray-300">{% if entry.status == 'good' %}<span class="inline-block w-4 h-4 rounded-full bg-green-500 border-2 border-green-700" title="Good"></span>{% elif entry.status == 'moderate' %}<span class="inline-block w-4 h-4 rounded-full bg-yellow-400 border-2 border-yellow-600" title="Moderate"></span>{% else %}<span class="inline-block w-4 h-4 rounded-full bg-red-500 border-2 border-red-700" title="Bad"></span>{% endif %}</td>
                                        </tr>
                                        {% endfor %}
                                    {% endfor %}
                                </tbody>
                            </table>
                        </form>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <div class="flex flex-col items-center justify-center">
                 <img src="{% static 'assets/empty_state.svg' %}" alt="No BSC entries" width="213" height="100" />
                 <p class="text-gray-500 text-center text-sm font-medium">No BSC entries found for your organization.</p>
             </div>
            {% endif %}
            <!-- <div class="mt-8">
                <canvas id="bscChart" width="800" height="400"></canvas>
            </div> -->
            <script>
                fetch("{% url 'bsc_data_api' %}")
                    .then(response => response.json())
                    .then(data => {
                        const labels = data.entries.map(e => e.objective);
                        const actual = data.entries.map(e => parseFloat(e.actual));
                        const target = data.entries.map(e => parseFloat(e.target));
                        const ctx = document.getElementById('bscChart').getContext('2d');
                        new Chart(ctx, {
                            type: 'bar',
                            data: {
                                labels: labels,
                                datasets: [
                                    { label: 'Actual', data: actual, backgroundColor: 'rgba(34,197,94,0.7)' },
                                    { label: 'Target', data: target, backgroundColor: 'rgba(59,130,246,0.7)' }
                                ]
                            },
                            options: {
                                responsive: true,
                                plugins: { legend: { position: 'top' }, title: { display: true, text: 'BSC KPIs: Actual vs Target' } }
                            }
                        });
                    });
            </script>
        </div>
            {% endif %}
    </div>
    <script>
    function enableBatchEdit(batchId) {
        const table = document.getElementById('batch-table-' + batchId);
        const rows = table.querySelectorAll('tbody tr');
        rows.forEach(row => {
            const modelType = row.getAttribute('data-model');
            const pk = row.getAttribute('data-pk');
            row.querySelectorAll('td[data-field]').forEach(cell => {
                const field = cell.getAttribute('data-field');
                const value = cell.textContent.trim();
                const inputName = `${modelType}_${pk}_${field}`;
                if (field === 'date') {
                    cell.innerHTML = `<input type="date" name="${inputName}" value="${value && value !== 'None' ? value : ''}" class="w-full border rounded px-1 py-1 text-xs" />`;
                } else {
                    cell.innerHTML = `<input type="text" name="${inputName}" value="${value}" class="w-full border rounded px-1 py-1 text-xs" />`;
                }
            });
        });
        document.getElementById('edit-btn-' + batchId).classList.add('hidden');
        document.getElementById('save-btn-' + batchId).classList.remove('hidden');
        document.getElementById('cancel-btn-' + batchId).classList.remove('hidden');
    }
    function cancelBatchEdit(batchId) {
        window.location.reload();
    }
    function saveBatchEdit(batchId) {
        document.getElementById('batch-form-' + batchId).submit();
    }
    </script>
</body>

</html>